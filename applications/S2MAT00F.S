; Do not change filenames or add or remove FILEI/FILEO statements using an editor. Use Cube/Application Manager.
RUN PGM=MATRIX PRNFILE="C:\KumarA\NERPM\CUBE\S2MAT00F.PRN" MSG='Build Station to Station Matrices'
FILEI MATI[4] = "C:\KumarA\NERPM\CUBE\AMFLAGS.MAT"
FILEI MATI[3] = "C:\KumarA\NERPM\CUBE\S2PTR00D.DBF",
 PATTERN=IJ:V FIELDS=I,J,MODE
FILEI MATI[2] = "C:\KumarA\NERPM\CUBE\S2PTR00D.DBF",
 PATTERN=IJ:V FIELDS=I,J,TONODE
FILEI MATI[1] = "C:\KumarA\NERPM\CUBE\S2PTR00D.DBF",
 PATTERN=IJ:V FIELDS=I,J,FROMNODE
FILEO MATO[1] = "C:\KumarA\NERPM\CUBE\STOSAMAULB.MAT",
 MO=51-52,55-59 NAME=AMFROMSTAT,AMTOSTAT,AMACCESSSPACE,AMPNRACCTERM,AMKNRTERM,NEARACSTAZ,PNRCOST FORMAT=TRANPLAN
PAR ZONES={ZONESA} zonemsg=100
; PARK STATION NUMBERS INTO A LOOKUP TABLE
;station, statnumber, spaces,pnrterm,knrterm,nearestzone(distance),nearestzone(statdata input),ampnrcost,mdpnrcost
  MW[100]=MI.4.1

LOOKUP LOOKUPI=1, NAME=STATIONS,
 LOOKUP[1]=1, RESULT=2,; STATION NUMBER
 LOOKUP[2]=1, RESULT=3,; SPACES
 LOOKUP[3]=1, RESULT=4,; PNR TERMINAL TIME
 LOOKUP[4]=1, RESULT=5,; KNR TERMINAL TIME
 LOOKUP[5]=1, RESULT=6,; NEAREST ZONE CROWFLY
 LOOKUP[7]=1, RESULT=7,; NEAREST ZONE (STATIONDATA)
 LOOKUP[8]=1, RESULT=8,; AM PNR COST
 LOOKUP[9]=1, RESULT=9,; MD PNR COST
 FAIL=0

MW[1]=MI.1.1 ; AM FROMNODE
MW[2]=MI.2.1 ; AM TONODE
MW[3]=MI.3.1 ; AM MODE
MW[100]=MI.4.1
JLOOP
 ;FIRST FIGURE OUT THE STATION EQUIVALENT FOR EACH CELL, 0 IF NO MATCH
 ;NEXT, ASSIGN THE STATION EQUIVALENT FOR EACH CELL TO A WORK MATRIX
  STATID=STATIONS(1,MW[1][J],0)
  MW[51][J]=STATID
  STATID=STATIONS(1,MW[2][J],0)
  MW[52][J]=STATID
  ;NOW BUILD MATRICES OF THE ACCESS CHARACTER OF EACH STATION (SPACES, PNR TERMINAL TIME, KNR TERMINAL TIME)
  ACCESSSPACE=STATIONS(2,MW[1][J],0)
  PNRACCTERM=STATIONS(3,MW[1][J],0)
  KNRACCTERM=STATIONS(4,MW[1][J],0)
  ACCESSTAZ=STATIONS(5,MW[1][J],0)
  PARKINGCOST=STATIONS(8,MW[1][J],0)
  MW[55][J]=ACCESSSPACE
  MW[56][J]=PNRACCTERM
  MW[57][J]=KNRACCTERM
  MW[58][J]=ACCESSTAZ
  MW[59][J]=PARKINGCOST

  ;clean up where start and end stations are the same OR do not both board and alight at a station
  if (mw[51][j]=mw[52][j]|MW[51][J]=0|MW[52][J]=0) mw[51][j]=0 mw[52][j]=0 mw[3][j]=0 mw[55]=0 mw[56]=0 mw[57]=0 mw[58]=0 MW[59]=0
  ENDJLOOP
  LOOP WW=51,59
    MW[WW]=MW[100]*MW[WW]
  ENDLOOP
ENDRUN
